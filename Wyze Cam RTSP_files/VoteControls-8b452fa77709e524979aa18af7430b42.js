(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{"6aee6681716a723e926b":function(e,t,a){"use strict";a.r(t);var n,o=a("5f95f5d90d238fa0d86a"),i=a.n(o),s=a("802cdb4f0b591dfd1229"),l=a.n(s),r=a("a8f8105d2d40178f277f"),u=a("1858b45bf48591489d06"),c=a("279c0f0c00aa45d41952"),d=a.n(c),h=a("500407a0058749d1d795"),v=a.n(h),f=a("e3f51e93cbcb086f6c06"),p=a.n(f),b=a("f53a66fb701477ccb562"),g=a.n(b),m=a("12567f097106441c944d"),y=u.Model.extend({defaults:{upvote_count:0,vote_count:0,vote_sum:0,value:null,label:"",vote_url:""},constructor:function(){u.Model.apply(this,arguments),this.localStorageSupported=this.isLocalStorageSupported(),this.set({value:this.getVoteDirection()})},vote:(n=p()(v.a.mark((function e(t){var a,n,o=this;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.get("vote_url"),!this.alreadyVoted()){e.next=4;break}return this.fakeVote(t),e.abrupt("return");case 4:return e.next=6,Object(m.b)();case 6:n=e.sent,u.$.ajax({url:a,type:"POST",data:{value:t},dataType:"json",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",n)}}).done((function(e){o.saveVoteLocally(e.value),o.set(e)})).fail((function(){o.saveVoteLocally(t),o.set({value:t})}));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)}),alreadyVoted:function(){return null!==this.get("value")},getVoteDirection:function(){return this.readLocalVotes()[this.get("vote_url")]||null},fakeVote:function(e){var t=this.get("value")===e?"none":e;this.saveVoteLocally(t),this.set({value:t})},saveVoteLocally:function(e){var t=this.get("vote_url"),a=this.readLocalVotes();a[t]=e;var n=d()(a);this.localStorageSupported?window.localStorage.setItem("articleVotes",n):g.a.set("articleVotes",n)},readLocalVotes:function(){var e=this.localStorageSupported?window.localStorage.getItem("articleVotes"):g.a.get("articleVotes");return JSON.parse(e||"{}")},isLocalStorageSupported:function(){try{return window.localStorage.setItem("testKey","1"),window.localStorage.removeItem("testKey"),!0}catch(e){return!1}}}),w=u.Model.extend({defaults:{upvote_count:0,vote_count:0,vote_sum:0,value:null,label:"",vote_url:""},vote:function(){var e=p()(v.a.mark((function e(t){var a,n,o,i,s=this;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.get("value"),n=this.get("vote_url"),e.next=4,Object(m.b)();case 4:o=e.sent,i=a?a===t?"DELETE":"PUT":"POST",u.$.ajax({type:i,url:n,data:{value:t},dataType:"json",beforeSend:function(e){e.setRequestHeader("X-CSRF-Token",o)}}).then((function(e){return s.set(e)}));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}),_=a("c941771c892f8eea9763"),S=a.n(_),V=a("e026a4a5eab83117dbc9"),x=a.n(V),k=u.View.extend({cleanupAttributes:function(){for(var e=this,t=this.el.attributes,a=[],n=0;n<t.length;n++){var o=t[n].nodeName;-1!==x()(o).call(o,"data-")&&a.push(o)}S()(a).call(a,(function(t){return e.el.removeAttribute(t)}))}}),C=k.extend({events:{click:"onClick"},initialize:function(e){var t=e.direction,a=e.selectedClass;this.direction=t,this.selectedClass=a,this.listenTo(this.model,"change",this.render),this.cleanupAttributes()},render:function(){var e=this.direction===this.model.get("value"),t=1===r.a.get("theming_api_version")?"aria-selected":"aria-pressed";this.$el.toggleClass(this.selectedClass,e).attr(t,e)},onClick:function(e){e.preventDefault(),this.model.vote(this.direction)}}),T=k.extend({initialize:function(){this.listenTo(this.model,"change",this.render),this.cleanupAttributes()},render:function(){this.$el.text(this.model.get("label"))}}),L=k.extend({initialize:function(e){var t=e.type;this.type=t,this.listenTo(this.model,"change",this.render),this.cleanupAttributes()},render:function(){var e;switch(this.type){case"sum":e=this.model.get("vote_sum");break;case"count":e=this.model.get("vote_count")}this.$el.text(e)}});function j(e){var t=l()("[data-helper=vote][data-item=".concat(e,"]")),a=i()(t).call(t,"[data-type=up], [data-type=down]"),n=i()(t).call(t,"[data-type=label]"),o=i()(t).call(t,"[data-type=count], [data-type=sum]");if(a.length){var s=r.a.get("user.role"),c=r.a.get("has_anonymous_kb_voting"),d="article"===e&&c&&"anonymous"===s,h=new u.Collection(null,{model:d?y:w}),v={buttons:[],labels:[],counters:[]};a.each((function(){var e=l()(this).data(),t=e.id,a=e.value,n=e.label,o=e.type,i=e.selectedClass,s=e.upvoteCount,r=e.voteCount,u=e.voteSum,c=e.voteUrl,d=h.findWhere({id:t});d=d||h.add({id:t,value:a,label:n,upvote_count:s,vote_count:r,vote_sum:u,vote_url:c});var f=new C({model:d,el:this,direction:o,selectedClass:i});v.buttons.push(f),f.render()})),n.each((function(){var e=l()(this).data().id,t=h.findWhere({id:e}),a=new T({model:t,el:this});v.labels.push(a)})),o.each((function(){var e=l()(this).data(),t=e.id,a=e.type,n=h.findWhere({id:t}),o=new L({model:n,el:this,type:a});v.counters.push(o)})),this.votes=h,this.views=v}}a.d(t,"default",(function(){return j}))}}]);